<!DOCTYPE html>
<html lang='en'>

<head>
    <title>FlowFiles</title>
    <link rel='stylesheet' type='text/css' href='css/main.css'>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script type='text/javascript' src='https://d3js.org/d3.v5.min.js'></script>
    <script type='text/javascript' src='js/renderable.js'></script>
    <script type='text/javascript' src='js/flow-diagram.js'></script>
    <script type='text/javascript' src='js/flow-file.js'></script>
    <script type='text/javascript' src='js/processor.js'></script>
    <script type='text/javascript' src='js/controller-service.js'></script>
    <script type='text/javascript' src='js/arrow.js'></script>
    <script type='text/javascript' src='js/tooltip.js'></script>
</head>

<body>
    <div id="flow-diagram">
        <div id="left-pane">
            <h3>Data Flow Patterns</h3>
            <div id="diagram-navi"></div>
        </div>
        <div id="right-pane">
            <div id="diagram-header">
                <div>
                    <h1 id="diagram-title">Apache NiFi Data Flow Patterns</h1>
                    <div id="control-panel" style="visibility: hidden;">
                        <i id="diagram-first" class="fa fa-angle-double-left"></i>
                        <i id="diagram-previous" class="fa fa-angle-left"></i>
                        <span id="diagram-index"></span>
                        <i id="diagram-next" class="fa fa-angle-right"></i>
                        <i id="diagram-last" class="fa fa-angle-double-right"></i>
                    </div>
                </div>
                <div>Show diagram meta data here</div>
            </div>
            <div id="diagram-body">
                <div id='diagram-container'>
                    <svg id="diagram-svg" width="600px" height="600px">
                        <defs>
                            <marker id='head' orient="auto" markerWidth='2' markerHeight='4' refX='2' refY='2'>
                                <path d='M0,0 V4 L2,2 Z' fill="#AEBAA7" />
                            </marker>
                        </defs>
                    </svg>
                </div>
            </div>
        </div>
    </div>

    <script>

        var adjustSVGSize = () => {
            d3.select('#diagram-svg')
            .attr('height', window.innerHeight - document.getElementById('diagram-header').scrollHeight - 5);
        }
        adjustSVGSize();
        window.addEventListener('resize', adjustSVGSize);

        d3.json('diagrams/index.json').then(diagrams => {
            d3.select('#diagram-navi')
                .append('ol')
                .selectAll('li')
                .data(diagrams)
                .enter()
                .append('li')
                .on('click', d => {
                    // Show hidden items.
                    d3.select('#control-panel').style('visibility', 'visible');

                    // Discard old rendered objects.
                    d3.select('#diagram-svg').selectAll('g').remove();
                    d3.select('#diagram-container').selectAll('div').remove();

                    // Remove old one first.
                    d3.select('#diagram-script')
                        .selectAll('script')
                        .remove();

                    // Add new script tag.
                    d3.select('#diagram-script')
                        .selectAll('script')
                        .data([d])
                        .enter()
                        .append('script')
                        .on('load', () => {
                            // Create diagram.
                            if (typeof createFlowDiagram === 'function') {
                                var flowDiagram = createFlowDiagram();
                                flowDiagram.render();
                            }
                        })
                        .attr('src', `diagrams/${d.name}.js`);

                })
                .text(d => d.name);
        });
    </script>

    <div id="diagram-script"></div>
</body>

</html>